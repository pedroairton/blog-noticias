<section class="admin news-form">
  <h1>{{ isEditMode ? "Editar Notícia" : "Nova Notícia" }}</h1>
  <p>
    Preencha todos os campos necessários para
    {{ isEditMode ? "editar" : "criar" }} a notícia
  </p>
  @if (isLoading) {
  <mat-spinner diameter="50"></mat-spinner>
  } @else {
  <form [formGroup]="newsForm" (ngSubmit)="onSubmit()">
    <div class="infos-noticia">
      <h2>Informações básicas</h2>
      <mat-form-field>
        <mat-label>Título</mat-label>
        <input matInput formControlName="title" placeholder="Digite o título" />
        <mat-icon matSuffix>title</mat-icon>
        @if (title?.invalid && title?.touched) {
        <mat-error>
          @if (title?.errors?.['required']) { O título é obrigatório } @if
          (title?.errors?.['minlength']) { O título deve ter no mínimo
          {{ title?.errors?.['minlength']?.requiredLength }} caracteres } @if
          (title?.errors?.['maxlength']) { O título deve ter no máximo
          {{ title?.errors?.['maxlength']?.requiredLength }} caracteres }
        </mat-error>
        }
      </mat-form-field>
      <mat-form-field>
        <mat-label>Subtítulo</mat-label>
        <input matInput formControlName="subtitle" placeholder="Digite o subtítulo (opcional)" />
        <mat-icon matSuffix>subtitles</mat-icon>
        <mat-hint>Máximo 500 caracteres</mat-hint>
      </mat-form-field>
      <mat-form-field>
        <mat-label>Categoria</mat-label>
        <mat-select formControlName="category_id">
          @if (categories?.length === 0) {
          <mat-option value="">Nenhuma categoria disponível</mat-option>
          } @for (category of categories; track category.id) {
          <mat-option [value]="category.id">
            {{ category.name }}
          </mat-option>
          }
        </mat-select>
        <mat-icon matSuffix>category</mat-icon>
        @if (category_id?.invalid && category_id?.touched) {
        <mat-error>Categoria é obrigatória</mat-error>
        }
      </mat-form-field>
      <mat-form-field>
        <mat-label>Tags</mat-label>
        <mat-select formControlName="tags" multiple>
          @for (tag of tags; track tag.id) {
          <mat-option [value]="tag.id">
            {{ tag.name }}
          </mat-option>
          }
        </mat-select>
        <mat-icon matSuffix>local_offer</mat-icon>
      </mat-form-field>
      <mat-form-field>
        <mat-label>Resumo da Notícia</mat-label>
        <textarea matInput formControlName="excerpt" placeholder="Digite um breve resumo da notícia" rows="3"
          maxlength="500"></textarea>
        <mat-icon matSuffix>description</mat-icon>
        <mat-hint>{{ excerpt?.value?.length || 0 }}/500 caracteres</mat-hint>
        @if (excerpt?.invalid && excerpt?.touched) {
        <mat-error>
          @if (excerpt?.errors?.['required']) { Resumo é obrigatório } @if
          (excerpt?.errors?.['maxlength']) { Máximo de 500 caracteres }
        </mat-error>
        }
      </mat-form-field>
    </div>

    <div class="img-noticia">
      <h2>Imagem Principal</h2>
      @if (mainImagePreview) {
      <div class="preview-imagem">
        <div class="container-imagem">
          <img [src]="mainImagePreview" alt="Prévia da imagem principal" />
          <button mat-icon-button color="warn" (click)="removeMainImage()" type="button">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <mat-form-field>
          <mat-label>Legenda da Imagem</mat-label>
          <input matInput formControlName="main_image_caption" />
          <mat-hint>Máximo 255 caracteres</mat-hint>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Texto Alternativo (Alt Text)</mat-label>
          <input matInput formControlName="main_image_alt" />
          <mat-hint>Importante para SEO e acessibilidade</mat-hint>
        </mat-form-field>
      </div>
      }
      <div class="upload">
        <input #mainImageInput type="file" accept="image/*" (change)="onMainImageSelected($event)" />
        <mat-icon>cloud_upload</mat-icon>
        <p>Arraste uma imagem ou clique para selecionar</p>
        <button mat-raised-button color="primary" type="button" (click)="mainImageInput.click()">
          <mat-icon>upload</mat-icon>
          Selecionar Imagem Principal
        </button>
        <p>Recomendado 1200x630px, máximo 2MB (webp, jpg, png, gif)</p>
      </div>
    </div>

    <div class="galeria">
      <h2>Galeria de imagens</h2>
      <input #galleryInput type="file" accept="image/*" multiple (change)="onGallerySelected($event)" />
      <button mat-raised-button color="accent" type="button" (click)="galleryInput.click()">
        <mat-icon>add_photo_alternate</mat-icon>
        Adicionar imagens à galeria
      </button>
      <p>Você pode selecionar múltiplas imagens (máximo 2MB cada)</p>

      @if (galleryPreviews.length) {
      <h3>Imagens selecionadas: {{ galleryPreviews.length }}</h3>
      <div class="imgs-galeria">
        @for (preview of galleryPreviews; track $index; let i = $index) {
        <div class="container-img-galeria">
          <img class="img-galeria" [src]="preview" [alt]="'Imagem ' + (i + 1)" />
          <div class="acoes">
            <button mat-icon-button color="warn" type="button" (click)="removeGalleryImage(i)">
              <mat-icon>delete</mat-icon>
            </button>
            <button mat-icon-button color="primary" type="button" (click)="insertImageInContent(preview.preview)">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
        }
      </div>
      }
    </div>

    <div class="conteudo-noticia">
      <h2>Conteúdo da Notícia</h2>
      <div>
        <quill-editor formControlName="content" [modules]="quillConfig"
          placeholder="Escreva o conteúdo da notícia aqui..."></quill-editor>
      </div>

      @if (content?.invalid && content?.touched) {
      <mat-error>Conteúdo é obrigatório</mat-error>
      }

      <div>
        <p>
          <b>Dica:</b> Você pode inserir imagens da galeria diretamente no
          conteúdo clicando no botão "Inserir no conteúdo" nas imagens acima.
        </p>
      </div>
    </div>
    <hr>
    <div class="acoes">
      <button mat-button type="button" routerLink="/admin/noticias" [disabled]="isLoading" class="btn-cancelar">
        Cancelar
      </button>
      <button mat-button type="button" (click)="saveDraft()" [disabled]="isLoading || newsForm.invalid"
        class="btn-salvar-rascunho">
        <mat-icon>save</mat-icon>
        Salvar Rascunho
      </button>
      <button mat-raised-button type="submit" [disabled]="isLoading || newsForm.invalid" class="btn-salvar">
        <mat-icon>{{ isEditMode ? "update" : "add" }}</mat-icon>
        {{ isEditMode ? "Atualizar" : "Criar" }}
      </button>

      @if (authService.isSuperAdmin()) {
      <button mat-raised-button color="accent" type="button" (click)="publish()"
        [disabled]="isLoading || newsForm.invalid">
        <mat-icon>publish</mat-icon>
        Publicar agora
      </button>
      }
    </div>
  </form>
  }
</section>
<!-- modelo temporário, apagar futuramente -->
<div class="admin news-form">
  <div class="container mx-auto px-4 py-8">
    <!-- Cabeçalho -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">
        {{ isEditMode ? "Editar Notícia" : "Nova Notícia" }}
      </h1>
      <p class="text-gray-600 mt-2">
        Preencha todos os campos obrigatórios para
        {{ isEditMode ? "editar" : "criar" }} a notícia
      </p>
    </div>

    <!-- Loading -->
    @if (isLoading) {
    <div class="flex justify-center items-center h-64">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
    } @else {
    <!-- Formulário -->
    <form [formGroup]="newsForm" (ngSubmit)="onSubmit()" class="space-y-8">
      <!-- Informações Básicas -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">
          Informações Básicas
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Título -->
          <div class="md:col-span-2">
            <mat-form-field class="w-full">
              <mat-label>Título da Notícia *</mat-label>
              <input matInput formControlName="title" placeholder="Digite o título" />
              <mat-icon matSuffix>title</mat-icon>
              @if (title?.invalid && title?.touched) {
              <mat-error>
                @if (title?.errors?.['required']) { Título é obrigatório } @if
                (title?.errors?.['maxlength']) { Máximo de 255 caracteres }
              </mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Subtítulo -->
          <div class="md:col-span-2">
            <mat-form-field class="w-full">
              <mat-label>Subtítulo</mat-label>
              <input matInput formControlName="subtitle" placeholder="Digite o subtítulo (opcional)" />
              <mat-icon matSuffix>subtitles</mat-icon>
              <mat-hint>Máximo 500 caracteres</mat-hint>
            </mat-form-field>
          </div>

          <!-- Categoria -->
          <div>
            <mat-form-field class="w-full">
              <mat-label>Categoria *</mat-label>
              <mat-select formControlName="category_id">
                @for (category of categories; track category.id) {
                <mat-option [value]="category.id">
                  {{ category.name }}
                </mat-option>
                }
              </mat-select>
              <mat-icon matSuffix>category</mat-icon>
              @if (category_id?.invalid && category_id?.touched) {
              <mat-error>Categoria é obrigatória</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Tags -->
          <div>
            <mat-form-field class="w-full">
              <mat-label>Tags</mat-label>
              <mat-select formControlName="tags" multiple>
                @for (tag of tags; track tag.id) {
                <mat-option [value]="tag.id">
                  {{ tag.name }}
                </mat-option>
                }
              </mat-select>
              <mat-icon matSuffix>local_offer</mat-icon>
            </mat-form-field>
          </div>
        </div>

        <!-- Resumo -->
        <div class="mt-6">
          <mat-form-field class="w-full">
            <mat-label>Resumo da Notícia *</mat-label>
            <textarea matInput formControlName="excerpt" placeholder="Digite um breve resumo da notícia" rows="3"
              maxlength="500">
            </textarea>
            <mat-icon matSuffix>description</mat-icon>
            <mat-hint>{{ excerpt?.value?.length || 0 }}/500 caracteres</mat-hint>
            @if (excerpt?.invalid && excerpt?.touched) {
            <mat-error>
              @if (excerpt?.errors?.['required']) { Resumo é obrigatório } @if
              (excerpt?.errors?.['maxlength']) { Máximo de 500 caracteres }
            </mat-error>
            }
          </mat-form-field>
        </div>
      </div>

      <!-- Imagem Principal -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">
          Imagem Principal
        </h2>

        <!-- Preview da Imagem -->
        @if (mainImagePreview) {
        <div class="mb-6">
          <div class="relative max-w-2xl mx-auto">
            <img [src]="mainImagePreview" alt="Preview da imagem principal"
              class="w-full h-auto rounded-lg shadow-lg" />
            <button mat-icon-button color="warn" class="absolute top-2 right-2 bg-white shadow-lg"
              (click)="removeMainImage()" type="button">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Metadados da Imagem -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            <mat-form-field class="w-full">
              <mat-label>Legenda da Imagem</mat-label>
              <input matInput formControlName="main_image_caption" />
              <mat-hint>Máximo 255 caracteres</mat-hint>
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Texto Alternativo (Alt Text)</mat-label>
              <input matInput formControlName="main_image_alt" />
              <mat-hint>Importante para SEO e acessibilidade</mat-hint>
            </mat-form-field>
          </div>
        </div>
        }

        <!-- Upload -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
          <input #mainImageInput type="file" accept="image/*" (change)="onMainImageSelected($event)" class="hidden" />

          <mat-icon class="text-6xl text-gray-400 mb-4">cloud_upload</mat-icon>
          <p class="text-gray-600 mb-4">
            Arraste uma imagem ou clique para selecionar
          </p>
          <button mat-raised-button color="primary" type="button" (click)="mainImageInput.click()">
            <mat-icon>upload</mat-icon>
            Selecionar Imagem Principal
          </button>
          <p class="text-sm text-gray-500 mt-2">
            Recomendado: 1200x630px, máximo 2MB (JPEG, PNG, GIF, WebP)
          </p>
        </div>
      </div>

      <!-- Galeria de Imagens -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">
          Galeria de Imagens
        </h2>

        <!-- Galeria Existente (modo edição) -->
        @if (isEditMode && existingGalleryImages.length) {
        <div class="mb-8">
          <h3 class="text-lg font-medium text-gray-700 mb-4">Imagens já na galeria</h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            @for (image of existingGalleryImages; track image.id; let i = $index) {
            <div class="relative group">
              <img [src]="image.thumbnail_url || image.image_url" [alt]="image.alt_text || 'Imagem da galeria'"
                class="w-full h-32 object-cover rounded-lg shadow cursor-pointer"
                (click)="insertImageInContent(image.image_url!, image.alt_text)">

              <!-- Badge com informações -->
              <div class="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                {{ image.dimensions?.width || 0 }}x{{ image.dimensions?.height || 0 }}
              </div>

              <!-- Overlay com ações -->
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 
                              transition-all duration-200 rounded-lg flex flex-col justify-end p-2
                              opacity-0 group-hover:opacity-100">
                <div class="flex justify-between">
                  <button mat-icon-button color="primary" class="bg-white" (click)="openImageDialog(i, false)"
                    matTooltip="Editar">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" class="bg-white" (click)="removeExistingGalleryImage(image.id)"
                    matTooltip="Remover">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
            }
          </div>
        </div>
        }

        <!-- Upload de Novas Imagens -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
          <input 
            #galleryInput
            type="file" 
            accept="image/*"
            multiple
            (change)="onGallerySelected($event)"
            class="hidden">
          
          <mat-icon class="text-6xl text-gray-400 mb-4">add_photo_alternate</mat-icon>
          <p class="text-gray-600 mb-4">
            Arraste imagens ou clique para selecionar
          </p>
          <button 
            mat-raised-button 
            color="primary"
            type="button"
            (click)="galleryInput.click()">
            <mat-icon>add</mat-icon>
            Adicionar à Galeria
          </button>
          <p class="text-sm text-gray-500 mt-2">
            Máximo 2MB por imagem (JPEG, PNG, GIF, WebP)
          </p>
        </div>

        <!-- Pré-visualização da Galeria -->
        @if (galleryPreviews.length) {
          <div>
            <h3 class="text-lg font-medium text-gray-700 mb-4">
              Imagens selecionadas ({{ galleryPreviews.length }})
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
              @for (preview of galleryPreviews; track $index; let i = $index) {
                <div class="relative group">
                  <img 
                    [src]="preview.preview" 
                    [alt]="preview.alt_text || 'Nova imagem'"
                    class="w-full h-32 object-cover rounded-lg shadow cursor-pointer"
                    (click)="insertImageInContent(preview.preview, preview.alt_text)">
                  
                  <!-- Badge -->
                  <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded">
                    Nova
                  </div>
                  
                  <!-- Overlay com ações -->
                  <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 
                              transition-all duration-200 rounded-lg flex flex-col justify-end p-2
                              opacity-0 group-hover:opacity-100 overlay-img">
                    <div class="flex justify-between">
                      <button 
                        mat-icon-button 
                        color="primary"
                        class="bg-white"
                        (click)="openImageDialog(i)"
                        matTooltip="Configurar">
                        <mat-icon>settings</mat-icon>
                      </button>
                      <button 
                        mat-icon-button 
                        color="warn"
                        class="bg-white"
                        (click)="removeGalleryImage(i)"
                        matTooltip="Remover">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Editor de Conteúdo -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">
          Conteúdo da Notícia *
        </h2>

        <div class="border border-gray-300 rounded-lg overflow-hidden">
          <quill-editor formControlName="content" [modules]="quillConfig"
            placeholder="Digite o conteúdo da notícia aqui..." class="min-h-[400px]">
          </quill-editor>
        </div>

        @if (content?.invalid && content?.touched) {
        <mat-error class="mt-2">Conteúdo é obrigatório</mat-error>
        }

        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
          <p class="text-blue-800 text-sm">
            <strong>Dica:</strong> Você pode inserir imagens da galeria
            diretamente no conteúdo clicando no botão "Inserir no conteúdo" nas
            imagens acima.
          </p>
        </div>
      </div>

      <!-- Botões de Ação -->
      <div class="flex flex-wrap gap-4 justify-end pt-6 border-t border-gray-200">
        <button mat-button type="button" routerLink="/admin/noticias" [disabled]="isLoading">
          Cancelar
        </button>

        <button mat-button type="button" color="primary" (click)="saveDraft()"
          [disabled]="isLoading || newsForm.invalid">
          <mat-icon>save</mat-icon>
          Salvar Rascunho
        </button>

        <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || newsForm.invalid">
          <mat-icon>{{ isEditMode ? "update" : "add" }}</mat-icon>
          {{ isEditMode ? "Atualizar" : "Criar" }} Notícia
        </button>

        @if (authService.isSuperAdmin()) {
        <button mat-raised-button color="accent" type="button" (click)="publish()"
          [disabled]="isLoading || newsForm.invalid">
          <mat-icon>publish</mat-icon>
          Publicar Agora
        </button>
        }
      </div>
    </form>
    }
  </div>
</div>